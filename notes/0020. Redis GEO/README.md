# [0020. Redis GEO](https://github.com/Tdahuyou/TNotes.redis/tree/main/notes/0020.%20Redis%20GEO)

<!-- region:toc -->

- [1. ğŸ“ æ¦‚è¿°](#1--æ¦‚è¿°)
- [2. ğŸ“’ Redis GEO](#2--redis-geo)
- [3. ğŸ’» `geoadd`](#3--geoadd)
- [4. ğŸ’» `geopos`](#4--geopos)
- [5. ğŸ’» `geodist`](#5--geodist)
- [6. ğŸ’» `georadius`ã€`georadiusbymember`](#6--georadiusgeoradiusbymember)
- [7. ğŸ’» `geohash`](#7--geohash)
- [8. ğŸ”— References](#8--references)

<!-- endregion:toc -->

## 1. ğŸ“ æ¦‚è¿°

- äº†è§£ Redis GEO çš„åŸºæœ¬ä½¿ç”¨ã€‚

## 2. ğŸ“’ Redis GEO

Redis GEO ä¸»è¦ç”¨äºå­˜å‚¨ **åœ°ç†ä½ç½®ä¿¡æ¯**ï¼Œå¹¶å¯¹å­˜å‚¨çš„ä¿¡æ¯è¿›è¡Œæ“ä½œï¼Œè¯¥åŠŸèƒ½åœ¨ Redis 3.2 ç‰ˆæœ¬æ–°å¢ã€‚

Redis GEO æ“ä½œæ–¹æ³•æœ‰ï¼š

- `geoadd`ï¼šæ·»åŠ åœ°ç†ä½ç½®çš„åæ ‡ã€‚
- `geopos`ï¼šè·å–åœ°ç†ä½ç½®çš„åæ ‡ã€‚
- `geodist`ï¼šè®¡ç®—ä¸¤ä¸ªä½ç½®ä¹‹é—´çš„è·ç¦»ã€‚
- `georadius`ï¼šæ ¹æ®ç”¨æˆ·ç»™å®šçš„ç»çº¬åº¦åæ ‡æ¥è·å–æŒ‡å®šèŒƒå›´å†…çš„åœ°ç†ä½ç½®é›†åˆã€‚
- `georadiusbymember`ï¼šæ ¹æ®å‚¨å­˜åœ¨ä½ç½®é›†åˆé‡Œé¢çš„æŸä¸ªåœ°ç‚¹è·å–æŒ‡å®šèŒƒå›´å†…çš„åœ°ç†ä½ç½®é›†åˆã€‚
- `geohash`ï¼šè¿”å›ä¸€ä¸ªæˆ–å¤šä¸ªä½ç½®å¯¹è±¡çš„ geohash å€¼ã€‚

## 3. ğŸ’» `geoadd`

- geoadd ç”¨äºå­˜å‚¨æŒ‡å®šçš„åœ°ç†ç©ºé—´ä½ç½®ï¼Œå¯ä»¥å°†ä¸€ä¸ªæˆ–å¤šä¸ªç»åº¦(longitude)ã€çº¬åº¦(latitude)ã€ä½ç½®åç§°(member)æ·»åŠ åˆ°æŒ‡å®šçš„ key ä¸­ã€‚
- geoadd è¯­æ³•æ ¼å¼å¦‚ä¸‹ï¼š

```bash
GEOADD key longitude latitude member [longitude latitude member ...]
```

- ä»¥ä¸‹å®ä¾‹ä¸­ key ä¸º Sicilyï¼ŒPalermo å’Œ Catania ä¸ºä½ç½®åç§°ï¼š

```bash
GEOADD Sicily 13.361389 38.115556 "Palermo" 15.087269 37.502669 "Catania"
# (integer) 2
# ä½¿ç”¨ geoadd å‘½ä»¤å°†ä¸¤ä¸ªåœ°ç†ä½ç½®æ·»åŠ åˆ° key ä¸º Sicily çš„é›†åˆä¸­ã€‚
# "Palermo" çš„ç»çº¬åº¦æ˜¯ (13.361389, 38.115556)ã€‚
# "Catania" çš„ç»çº¬åº¦æ˜¯ (15.087269, 37.502669)ã€‚
# è¿”å›å€¼ (integer) 2 è¡¨ç¤ºæˆåŠŸæ·»åŠ äº†ä¸¤ä¸ªä½ç½®ã€‚

GEODIST Sicily Palermo Catania
# "166274.1516"
# è®¡ç®— Sicily é›†åˆä¸­ "Palermo" å’Œ "Catania" ä¹‹é—´çš„è·ç¦»ã€‚
# è¿”å›å€¼ "166274.1516" æ˜¯ä¸¤è€…ä¹‹é—´çš„è·ç¦»ï¼Œå•ä½ä¸ºç±³ã€‚

GEORADIUS Sicily 15 37 100 km
# 1) "Catania"
# æŸ¥è¯¢ä»¥ç»çº¬åº¦ (15, 37) ä¸ºä¸­å¿ƒï¼ŒåŠå¾„ 100 åƒç±³èŒƒå›´å†…çš„æ‰€æœ‰åœ°ç†ä½ç½®ã€‚
# ç»“æœä¸º 1) "Catania"ï¼Œè¡¨ç¤º "Catania" åœ¨æŒ‡å®šèŒƒå›´å†…ã€‚

GEORADIUS Sicily 15 37 200 km
# 1) "Palermo"
# 2) "Catania"
# æŸ¥è¯¢æ¡ä»¶åŒä¸Šï¼Œä½†åŠå¾„å¢åŠ åˆ° 200 åƒç±³ã€‚
# è¿”å›ç»“æœåŒ…å« "Palermo" å’Œ "Catania"ï¼Œè¯´æ˜ä¸¤è€…éƒ½åœ¨è¯¥èŒƒå›´å†…ã€‚
```

> - **Sicily**ï¼šè¥¿è¥¿é‡Œå²›ï¼Œæ˜¯åœ°ä¸­æµ·æœ€å¤§çš„å²›å±¿ï¼Œä½äºæ„å¤§åˆ©å—éƒ¨ï¼Œå¸¸ç”¨äºç¤ºä¾‹åœ°ç†æ•°æ®çš„å­˜å‚¨é›†åˆã€‚
> - **Palermo**ï¼šå·´å‹’è«ï¼Œæ˜¯è¥¿è¥¿é‡Œå²›çš„é¦–åºœï¼Œä½äºå²›å±¿çš„è¥¿åŒ—æµ·å²¸ï¼Œå…·æœ‰å…¸å‹çš„åœ°ä¸­æµ·æ°”å€™ã€‚
> - **Catania**ï¼šå¡å¡”å°¼äºšï¼Œä½äºè¥¿è¥¿é‡Œå²›ä¸œå²¸ï¼Œé è¿‘åŸƒç‰¹çº³ç«å±±ï¼Œæ˜¯å²›ä¸Šé‡è¦çš„å·¥ä¸šä¸æ—…æ¸¸åŸå¸‚ã€‚

## 4. ğŸ’» `geopos`

- geopos ç”¨äºä»ç»™å®šçš„ key é‡Œè¿”å›æ‰€æœ‰æŒ‡å®šåç§°(member)çš„ä½ç½®ï¼ˆç»åº¦å’Œçº¬åº¦ï¼‰ï¼Œä¸å­˜åœ¨çš„è¿”å› nilã€‚
- geopos è¯­æ³•æ ¼å¼å¦‚ä¸‹ï¼š

```bash
GEOPOS key member [member ...]
```

```bash
GEOADD Sicily 13.361389 38.115556 "Palermo" 15.087269 37.502669 "Catania"
# (integer) 2

GEOPOS Sicily Palermo Catania NonExisting
# 1) 1) "13.361389338970184"
#    2) "38.1155563954963"
# 2) 1) "15.087267458438873"
#    2) "37.50266842333162"
# 3) (nil)

# GEOPOS Sicily Palermo Catania NonExisting
# è¡¨ç¤ºä» key ä¸º Sicily çš„ GEO é›†åˆä¸­è·å–æˆå‘˜ Palermoã€Catania å’Œ NonExisting çš„åœ°ç†ä½ç½®åæ ‡ã€‚

# 1) 1) "13.361389338970184"
#    2) "38.1155563954963"
# è¿™æ˜¯ Palermo çš„ç»çº¬åº¦åæ ‡ï¼š
# ç»åº¦ï¼ˆlongitudeï¼‰ï¼š13.36138933897018433
# çº¬åº¦ï¼ˆlatitudeï¼‰ï¼š38.11555639549629859

# 2) 1) "15.087267458438873"
#    2) "37.50266842333162"
# è¿™æ˜¯ Catania çš„ç»çº¬åº¦åæ ‡ï¼š
# ç»åº¦ï¼ˆlongitudeï¼‰ï¼š15.08726745843887329
# çº¬åº¦ï¼ˆlatitudeï¼‰ï¼š37.50266842333162032

# 3) (nil)
# NonExisting æ˜¯ä¸€ä¸ªä¸å­˜åœ¨äº Sicily é›†åˆä¸­çš„æˆå‘˜ï¼Œå› æ­¤å…¶ç»“æœä¸º (nil)ï¼Œè¡¨ç¤ºè¯¥æˆå‘˜æ²¡æœ‰å¯¹åº”çš„åœ°ç†ä½ç½®æ•°æ®ã€‚
```

- **ğŸ¤” ä¸ºä»€ä¹ˆé€šè¿‡ geopos è¯»å–åˆ°çš„ç²¾åº¦æ¯” geoadd å†™å…¥æ—¶è¦é«˜ï¼Ÿ**
  - é€šè¿‡ `GEOPOS` è¯»å–åˆ°çš„ç»çº¬åº¦ç²¾åº¦æ¯”å†™å…¥æ—¶æ›´é«˜çš„åŸå› æ˜¯ **Redis å†…éƒ¨ä½¿ç”¨æ›´é«˜ç²¾åº¦çš„æµ®ç‚¹æ•°å­˜å‚¨åœ°ç†åæ ‡**ï¼Œè€Œ `GEOADD` å‘½ä»¤åœ¨å†™å…¥æ—¶å…è®¸ç”¨æˆ·è¾“å…¥è¾ƒä½ç²¾åº¦çš„æ•°å€¼ï¼ˆå¦‚ä¿ç•™ 6 ä½å°æ•°ï¼‰ï¼Œä½†è¿™å¹¶ä¸æ„å‘³ç€å®é™…å­˜å‚¨çš„å°±æ˜¯è¿™ä¸ªç²¾åº¦ã€‚
  - **Redis ä½¿ç”¨ 52 ä½ geohash å­˜å‚¨åœ°ç†ä½ç½®**ï¼š
    - Redis GEO åº•å±‚åŸºäºæœ‰åºé›†åˆï¼ˆsorted setï¼‰å®ç°ï¼Œæ¯ä¸ª member çš„ score æ˜¯ä¸€ä¸ª 52 ä½çš„ geohash ç¼–ç å€¼ã€‚
    - è¿™ä¸ª geohash èƒ½å¤Ÿè¡¨ç¤ºéå¸¸ç²¾ç¡®çš„ä½ç½®ä¿¡æ¯ï¼Œå…¶ç²¾åº¦å¯è¾¾ **å‡ å˜ç±³çº§åˆ«**ã€‚
  - **å†™å…¥æ—¶æ¥å—æœ‰é™ç²¾åº¦çš„è¾“å…¥ï¼Œä½†å†…éƒ¨è½¬æ¢ä¸ºé«˜ç²¾åº¦æµ®ç‚¹æ•°**ï¼š
    - ç”¨æˆ·å†™å…¥æ—¶å¯èƒ½åªæä¾›å°‘é‡å°æ•°ä½æ•°ï¼ˆå¦‚ `13.361389` åªæœ‰ 6 ä½ï¼‰ï¼Œä½† Redis ä¼šå°†å…¶è½¬æ¢ä¸ºæ›´é«˜ç²¾åº¦çš„æµ®ç‚¹æ•°è¿›è¡Œå­˜å‚¨ã€‚
    - ç¤ºä¾‹ä¸­å†™å…¥çš„æ˜¯ `13.361389`ï¼Œä½†è¯»å‡ºçš„æ˜¯ `13.36138933897018433`ï¼Œè¯´æ˜å†…éƒ¨å­˜å‚¨ä½¿ç”¨äº†åŒç²¾åº¦æµ®ç‚¹æ•°ï¼ˆdoubleï¼‰ã€‚
  - **geopos è¿”å›çš„æ˜¯åŸå§‹æµ®ç‚¹å€¼çš„å­—ç¬¦ä¸²è¡¨ç¤º**ï¼š
    - å½“è°ƒç”¨ `GEOPOS` è¯»å–åæ ‡æ—¶ï¼Œè¿”å›çš„æ˜¯å†…éƒ¨å­˜å‚¨çš„å®Œæ•´æµ®ç‚¹æ•°çš„å­—ç¬¦ä¸²å½¢å¼ï¼Œå› æ­¤æ˜¾ç¤ºå‡ºäº†æ›´é«˜çš„å°æ•°ä½æ•°ã€‚
  - **ä¸ä¼šä¸¢å¤±ç²¾åº¦çš„è½¬æ¢æœºåˆ¶**ï¼š
    - Redis åœ¨æ¥æ”¶åœ°ç†åæ ‡æ—¶ï¼Œä¼šå°†ç»çº¬åº¦è½¬æ¢ä¸ºæ ‡å‡†çš„ WGS84 åæ ‡ç³»ç»Ÿä¸‹çš„æµ®ç‚¹æ•°å€¼ã€‚
    - å³ä½¿è¾“å…¥ç²¾åº¦è¾ƒä½ï¼Œæœ€ç»ˆéƒ½ä¼šè¢«æ ‡å‡†åŒ–å¹¶ä¿ç•™å°½å¯èƒ½å¤šçš„å°æ•°ä½ï¼Œä»¥ç¡®ä¿åç»­è®¡ç®—ï¼ˆå¦‚è·ç¦»ã€èŒƒå›´æŸ¥è¯¢ï¼‰çš„å‡†ç¡®æ€§ã€‚

| æ“ä½œ | ç²¾åº¦è¡¨ç° | åŸå›  |
| --- | --- | --- |
| `GEOADD` å†™å…¥ | ç”¨æˆ·å¯è¾“å…¥ä½ç²¾åº¦ï¼ˆå¦‚ 6 ä½å°æ•°ï¼‰ | æ¥å£å‹å¥½ï¼Œä¾¿äºæ‰‹åŠ¨æµ‹è¯•æˆ–è„šæœ¬ç¼–å†™ |
| `GEOPOS` è¯»å– | æ˜¾ç¤ºé«˜ç²¾åº¦ï¼ˆ15~17 ä½å°æ•°ï¼‰ | Redis å†…éƒ¨ä½¿ç”¨ double å­˜å‚¨ï¼Œå¹¶è¿”å›å®Œæ•´æ•°å€¼ |

## 5. ğŸ’» `geodist`

- geodist ç”¨äºè¿”å›ä¸¤ä¸ªç»™å®šä½ç½®ä¹‹é—´çš„è·ç¦»ã€‚
- geodist è¯­æ³•æ ¼å¼å¦‚ä¸‹ï¼š

```bash
GEODIST key member1 member2 [m|km|ft|mi]
```

- member1 member2 ä¸ºä¸¤ä¸ªåœ°ç†ä½ç½®ã€‚
- æœ€åä¸€ä¸ªè·ç¦»å•ä½å‚æ•°è¯´æ˜ï¼š
  - mï¼šç±³ï¼Œé»˜è®¤å•ä½ã€‚
  - kmï¼šåƒç±³ã€‚
  - miï¼šè‹±é‡Œã€‚
  - ftï¼šè‹±å°ºã€‚
- ç¤ºä¾‹ï¼šè®¡ç®— Palermo ä¸ Catania ä¹‹é—´çš„è·ç¦»ï¼š

```bash
GEOADD Sicily 13.361389 38.115556 "Palermo" 15.087269 37.502669 "Catania"
# (integer) 2

GEODIST Sicily Palermo Catania
# "166274.1516"

GEODIST Sicily Palermo Catania km
# "166.2742"

GEODIST Sicily Palermo Catania mi
# "103.3182"

GEODIST Sicily Foo Bar
# (nil)
```

> è½¬æ¢å…³ç³»ï¼š`1km = 0.621371mi = 0.3048ft`

## 6. ğŸ’» `georadius`ã€`georadiusbymember`

- georadius ä»¥ç»™å®šçš„ç»çº¬åº¦ä¸ºä¸­å¿ƒï¼Œ è¿”å›é”®åŒ…å«çš„ä½ç½®å…ƒç´ å½“ä¸­ï¼Œ ä¸ä¸­å¿ƒçš„è·ç¦»ä¸è¶…è¿‡ç»™å®šæœ€å¤§è·ç¦»çš„æ‰€æœ‰ä½ç½®å…ƒç´ ã€‚
- georadiusbymember å’Œ GEORADIUS å‘½ä»¤ä¸€æ ·ï¼Œ éƒ½å¯ä»¥æ‰¾å‡ºä½äºæŒ‡å®šèŒƒå›´å†…çš„å…ƒç´ ï¼Œ ä½†æ˜¯ georadiusbymember çš„ä¸­å¿ƒç‚¹æ˜¯ç”±ç»™å®šçš„ä½ç½®å…ƒç´ å†³å®šçš„ï¼Œ è€Œä¸æ˜¯ä½¿ç”¨ç»åº¦å’Œçº¬åº¦æ¥å†³å®šä¸­å¿ƒç‚¹ã€‚
- georadius ä¸ georadiusbymember è¯­æ³•æ ¼å¼å¦‚ä¸‹ï¼š

```bash
GEORADIUS key longitude latitude radius m|km|ft|mi [WITHCOORD] [WITHDIST] [WITHHASH] [COUNT count] [ASC|DESC] [STORE key] [STOREDIST key]

GEORADIUSBYMEMBER key member radius m|km|ft|mi [WITHCOORD] [WITHDIST] [WITHHASH] [COUNT count] [ASC|DESC] [STORE key] [STOREDIST key]
```

- å‚æ•°è¯´æ˜ï¼š
  - mï¼šç±³ï¼Œé»˜è®¤å•ä½ã€‚
  - kmï¼šåƒç±³ã€‚
  - miï¼šè‹±é‡Œã€‚
  - ftï¼šè‹±å°ºã€‚
  - WITHDISTï¼šåœ¨è¿”å›ä½ç½®å…ƒç´ çš„åŒæ—¶ï¼Œ å°†ä½ç½®å…ƒç´ ä¸ä¸­å¿ƒä¹‹é—´çš„è·ç¦»ä¹Ÿä¸€å¹¶è¿”å›ã€‚
  - WITHCOORDï¼šå°†ä½ç½®å…ƒç´ çš„ç»åº¦å’Œçº¬åº¦ä¹Ÿä¸€å¹¶è¿”å›ã€‚
  - WITHHASHï¼šä»¥ 52 ä½æœ‰ç¬¦å·æ•´æ•°çš„å½¢å¼ï¼Œ è¿”å›ä½ç½®å…ƒç´ ç»è¿‡åŸå§‹ geohash ç¼–ç çš„æœ‰åºé›†åˆåˆ†å€¼ã€‚ è¿™ä¸ªé€‰é¡¹ä¸»è¦ç”¨äºåº•å±‚åº”ç”¨æˆ–è€…è°ƒè¯•ï¼Œ å®é™…ä¸­çš„ä½œç”¨å¹¶ä¸å¤§ã€‚
  - COUNTï¼šé™å®šè¿”å›çš„è®°å½•æ•°ã€‚
  - ASCï¼šæŸ¥æ‰¾ç»“æœæ ¹æ®è·ç¦»ä»è¿‘åˆ°è¿œæ’åºã€‚
  - DESCï¼šæŸ¥æ‰¾ç»“æœæ ¹æ®ä»è¿œåˆ°è¿‘æ’åºã€‚

::: code-group

```bash [georadius]
GEOADD Sicily 13.361389 38.115556 "Palermo" 15.087269 37.502669 "Catania"
# (integer) 2

GEORADIUS Sicily 15 37 200 km WITHDIST
# 1) 1) "Palermo"
#    1) "190.4424"     # Palermo è·ç¦»ä¸­å¿ƒç‚¹ (15, 37) çº¦ 190.44 åƒç±³
# 2) 1) "Catania"
#    1) "56.4413"      # Catania è·ç¦»ä¸­å¿ƒç‚¹ (15, 37) çº¦ 56.44 åƒç±³

GEORADIUS Sicily 15 37 200 km WITHCOORD
# 1) 1) "Palermo"
#    1) 1) "13.36138933897018433"   # Palermo çš„ç»åº¦
#       1) "38.11555639549629859"   # Palermo çš„çº¬åº¦
# 2) 1) "Catania"
#    1) 1) "15.08726745843887329"   # Catania çš„ç»åº¦
#       1) "37.50266842333162032"   # Catania çš„çº¬åº¦

GEORADIUS Sicily 15 37 200 km WITHDIST WITHCOORD
# 1) 1) "Palermo"
#    1) "190.4424"                  # Palermo è·ç¦»ä¸­å¿ƒç‚¹çš„è·ç¦»ï¼ˆåƒç±³ï¼‰
#    2) 1) "13.36138933897018433"   # Palermo çš„ç»åº¦
#       1) "38.11555639549629859"   # Palermo çš„çº¬åº¦
# 2) 1) "Catania"
#    1) "56.4413"                   # Catania è·ç¦»ä¸­å¿ƒç‚¹çš„è·ç¦»ï¼ˆåƒç±³ï¼‰
#    2) 1) "15.08726745843887329"   # Catania çš„ç»åº¦
#       1) "37.50266842333162032"   # Catania çš„çº¬åº¦
```

```bash [georadiusbymember]
GEOADD Sicily 13.583333 37.316667 "Agrigento"
# (integer) 1
GEOADD Sicily 13.361389 38.115556 "Palermo" 15.087269 37.502669 "Catania"
# (integer) 2
GEORADIUSBYMEMBER Sicily Agrigento 100 km
# 1) "Agrigento"
# 2) "Palermo"
```

:::

## 7. ğŸ’» `geohash`

- Redis GEO ä½¿ç”¨ geohash æ¥ä¿å­˜åœ°ç†ä½ç½®çš„åæ ‡ã€‚
- geohash ç”¨äºè·å–ä¸€ä¸ªæˆ–å¤šä¸ªä½ç½®å…ƒç´ çš„ geohash å€¼ã€‚
- geohash è¯­æ³•æ ¼å¼å¦‚ä¸‹ï¼š

```bash
GEOHASH key member [member ...]
```

```bash
GEOADD Sicily 13.361389 38.115556 "Palermo" 15.087269 37.502669 "Catania"
# (integer) 2

GEOHASH Sicily Palermo Catania
# 1) "sqc8b49rny0"     # Palermo çš„ geohash ç¼–ç ï¼Œè¡¨ç¤ºå…¶åœ°ç†ä½ç½®çš„å­—ç¬¦ä¸²ç¼–ç å€¼
# 2) "sqdtr74hyu0"     # Catania çš„ geohash ç¼–ç ï¼Œç”¨äºé«˜æ•ˆå­˜å‚¨å’ŒæŸ¥è¯¢åœ°ç†åæ ‡
```

## 8. ğŸ”— References

- https://zh.wikipedia.org/zh-cn/%E4%B8%96%E7%95%8C%E5%A4%A7%E5%9C%B0%E6%B5%8B%E9%87%8F%E7%B3%BB%E7%BB%9F
  - wiki
  - ä¸–ç•Œå¤§åœ°æµ‹é‡ç³»ç»Ÿï¼ˆè‹±è¯­ï¼šWorld Geodetic System, WGSï¼‰æ˜¯ä¸€ç§ç”¨äºåœ°å›¾å­¦ã€å¤§åœ°æµ‹é‡å­¦å’Œå¯¼èˆªï¼ˆåŒ…æ‹¬å…¨çƒå®šä½ç³»ç»Ÿï¼‰çš„å¤§åœ°æµ‹é‡ç³»ç»Ÿæ ‡å‡†ã€‚
